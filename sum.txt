#!/bin/bash

systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target
#!/bin/bash

systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target
#!/usr/bin/env bash
set -euo pipefail

ENABLE_SLEEP_SCRIPT="$HOME/scripts/enable-sleep.sh"
CHECK_INTERVAL=60
PBS_SSH="root@main.l"

echo "‚è≥ Waiting for backups and ZFS sync jobs to finish..."

is_busy() {
    ps -ef | grep -q '[v]zdump' && return 0
    ps -ef | grep -q '[s]yncoid' && return 0
    ps -ef | grep -q '[z]fs send' && return 0
    ps -ef | grep -q '[z]fs receive' && return 0
    return 1
}

while is_busy; do
    echo "üîÑ Backup or sync still running, waiting $CHECK_INTERVAL seconds..."
    sleep "$CHECK_INTERVAL"
done

echo "‚úÖ No vzdump or syncoid activity detected."
echo "‚û° Enabling sleep on PBS..."

ssh "$PBS_SSH" "$ENABLE_SLEEP_SCRIPT"
echo "‚úî Sleep re-enabled."
#!/usr/bin/env bash
set -euo pipefail

ENABLE_SLEEP_SCRIPT="$HOME/scripts/enable-sleep.sh"
CHECK_INTERVAL=60
PBS_SSH="root@main.l"

echo "‚è≥ Waiting for backups and ZFS sync jobs to finish..."

is_busy() {
    ps -ef | grep -q '[v]zdump' && return 0
    ps -ef | grep -q '[s]yncoid' && return 0
    ps -ef | grep -q '[z]fs send' && return 0
    ps -ef | grep -q '[z]fs receive' && return 0
    return 1
}

while is_busy; do
    echo "üîÑ Backup or sync still running, waiting $CHECK_INTERVAL seconds..."
    sleep "$CHECK_INTERVAL"
done

echo "‚úÖ No vzdump or syncoid activity detected."
echo "‚û° Enabling sleep on PBS..."

ssh "$PBS_SSH" "$ENABLE_SLEEP_SCRIPT"
echo "‚úî Sleep re-enabled."
#!/bin/bash

systemctl unmask sleep.target suspend.target hibernate.target hybrid-sleep.target
#!/bin/bash

systemctl unmask sleep.target suspend.target hibernate.target hybrid-sleep.target
#!/bin/bash
wakeonlan 18:c0:4d:33:5c:c3
#!/bin/bash
wakeonlan 18:c0:4d:33:5c:c3
escape_html() {
    sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g'
}

send_notification() {
    local channel="$1"
    local status="$2"
    local message="$3"

    # Escape HTML special characters
    channel=$(printf "%s" "$channel" | escape_html)
    status=$(printf "%s" "$status" | escape_html)
    message=$(printf "%s" "$message" | escape_html)

    curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
        -d chat_id="$TG_CHAT_ID" \
        -d parse_mode="HTML" \
        -d text="<b>Channel:</b> ${channel}
<b>Status:</b> ${status}

${message}" > /dev/null
}escape_html() {
    sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g'
}

send_notification() {
    local channel="$1"
    local status="$2"
    local message="$3"

    # Escape HTML special characters
    channel=$(printf "%s" "$channel" | escape_html)
    status=$(printf "%s" "$status" | escape_html)
    message=$(printf "%s" "$message" | escape_html)

    curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
        -d chat_id="$TG_CHAT_ID" \
        -d parse_mode="HTML" \
        -d text="<b>Channel:</b> ${channel}
<b>Status:</b> ${status}

${message}" > /dev/null
}#!/usr/bin/env bash
set -euo pipefail


source ~/scripts/wait-for-pbs.sh

RUN_WOL=~/scripts/mmd_wol.sh
PBS_SSH="root@main.l"
DISABLE_SLEEP_SCRIPT="~/scripts/disable-sleep.sh"




disable_pbs_sleep() {
    echo "‚õî Disabling sleep on PBS..."
    ssh "$PBS_SSH" "$DISABLE_SLEEP_SCRIPT"
}



"$RUN_WOL"

wait_for_pbs

disable_pbs_sleep

sleep 2


#!/usr/bin/env bash
set -euo pipefail


source ~/scripts/wait-for-pbs.sh

RUN_WOL=~/scripts/mmd_wol.sh
PBS_SSH="root@main.l"
DISABLE_SLEEP_SCRIPT="~/scripts/disable-sleep.sh"




disable_pbs_sleep() {
    echo "‚õî Disabling sleep on PBS..."
    ssh "$PBS_SSH" "$DISABLE_SLEEP_SCRIPT"
}



"$RUN_WOL"

wait_for_pbs

disable_pbs_sleep

sleep 2


#!/bin/bash

DURATION=${1:-3600}

cleanup() {
  sudo systemctl unmask sleep.target suspend.target hibernate.target hybrid-sleep.target
  echo "‚úî Suspend re-enabled"
}

# Ensure cleanup always runs
trap cleanup EXIT INT TERM

echo "‚õî Disabling suspend for $DURATION seconds..."
sudo systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target

sleep "$DURATION"

echo "‚è± Time elapsed"
#!/bin/bash

DURATION=${1:-3600}

cleanup() {
  sudo systemctl unmask sleep.target suspend.target hibernate.target hybrid-sleep.target
  echo "‚úî Suspend re-enabled"
}

# Ensure cleanup always runs
trap cleanup EXIT INT TERM

echo "‚õî Disabling suspend for $DURATION seconds..."
sudo systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target

sleep "$DURATION"

echo "‚è± Time elapsed"
export TG_BOT_TOKEN=XXXXXXXXX
export  TG_CHAT_ID=-1003XXXXXXexport TG_BOT_TOKEN=XXXXXXXXX
export  TG_CHAT_ID=-1003XXXXXX#!/usr/bin/env bash
set -euo pipefail

PBS_SSH="root@main.l"

PBS_WAIT_TIMEOUT=300   # seconds
PBS_WAIT_INTERVAL=5


wait_for_pbs() {
    echo "‚è≥ Waiting for PBS to become reachable..."
    local waited=0

    until ssh -o ConnectTimeout=5 -o BatchMode=yes "$PBS_SSH" "true" 2>/dev/null; do
        sleep "$PBS_WAIT_INTERVAL"
        waited=$((waited + PBS_WAIT_INTERVAL))

        if (( waited >= PBS_WAIT_TIMEOUT )); then
            echo "‚ùå PBS not reachable after ${PBS_WAIT_TIMEOUT}s"
            return 1
        fi
    done

    echo "‚úÖ PBS is online"
}


#!/usr/bin/env bash
set -euo pipefail

PBS_SSH="root@main.l"

PBS_WAIT_TIMEOUT=300   # seconds
PBS_WAIT_INTERVAL=5


wait_for_pbs() {
    echo "‚è≥ Waiting for PBS to become reachable..."
    local waited=0

    until ssh -o ConnectTimeout=5 -o BatchMode=yes "$PBS_SSH" "true" 2>/dev/null; do
        sleep "$PBS_WAIT_INTERVAL"
        waited=$((waited + PBS_WAIT_INTERVAL))

        if (( waited >= PBS_WAIT_TIMEOUT )); then
            echo "‚ùå PBS not reachable after ${PBS_WAIT_TIMEOUT}s"
            return 1
        fi
    done

    echo "‚úÖ PBS is online"
}


#!/usr/bin/env bash
set -euo pipefail

source ~/scripts/notifications.sh
source ~/secret/saralab_bot.secret

LOCKFILE="/run/zfs-backup.lock"
START_TIME=$(date +%s)

PBS_HOST="pbs.l"
PBS_DATA="pbs/data_bkp"
PBS_VMS="pbs/vms_bkp"
DATASET_DIR="mmd_server/data"
CFG_DIR="/mmd_server/bkp/config"
VZDUMP_LOCK="/var/run/vzdump.lock"
LOG_FILE="/var/log/zfs-backup.log"
PBS_USER="root"
PBS_SSH="root@main.l"

PREPARE_FOR_BKP="$HOME/scripts/prepare-for-backup.sh"

WAIT_JOBS_ENABLE_SLEEP="$HOME/scripts/enable-sleep-no-jobs.sh"

PBS_WAIT_TIMEOUT=300   # seconds
PBS_WAIT_INTERVAL=5

# Redirect stdout/stderr to log file and console
mkdir -p "$(dirname "$LOG_FILE")"
exec > >(tee -a "$LOG_FILE") 2>&1

# Locking
exec 9>"$LOCKFILE"
flock -n 9 || { echo "Another backup is running, exiting."; exit 0; }


      
trap 'echo "‚ö†Ô∏è Backup interrupted!"; exit 1' INT  # Handle Ctrl+C
trap 'LINE=$LINENO; send_notification "ZFS Backup" "Failed" "Backup failed ‚ùå at line $LINE"; exit 1' ERR


echo "=== Backup started at $(date -Is) ==="

### ==============================
### Wait for vzdump
### ==============================
wait_for_vzdump() {
    [[ -e "$VZDUMP_LOCK" ]] || return 0
    echo "Waiting for vzdump..."
    exec 8<"$VZDUMP_LOCK"
    flock 8
    exec 8>&-
}

wait_for_vzdump




### ==============================
### 1Ô∏è‚É£ Backup Proxmox config
### ==============================
mkdir -p "$CFG_DIR"
CFG_FILE="$CFG_DIR/pve-config-$(date +%F).tar.gz"
echo "Creating Proxmox config backup..."
tar -czf "$CFG_FILE" \
  /etc/pve \
  /etc/network \
  /etc/ssh \
  /etc/apt \
  /etc/fstab \
  /etc/hosts
echo "‚úÖ Config backup done: $CFG_FILE"

wait_for_vzdump

SYNCOID_CMD=(
  syncoid
  --quiet
  --no-sync-snap
  --no-privilege-elevation
  --force-delete
  --recursive
)

### ==============================
### Wake PBS & prepare
### ==============================
"$PREPARE_FOR_BKP"

echo "Syncing datasets to PBS..."
trap - ERR

"${SYNCOID_CMD[@]}" "$DATASET_DIR" "$PBS_HOST:$PBS_DATA" 2>&1 | tee -a "$LOG_FILE"
status=${PIPESTATUS[0]}  # exit status of syncoid

trap 'LINE=$LINENO; send_notification "ZFS Backup" "Failed" "Backup failed ‚ùå at line $LINE"; exit 1' ERR

if [ $status -eq 0 ] || [ $status -eq 2 ]; then
    echo "‚úÖ Datasets synced (or nothing new to sync)"
else
    echo "‚ùå Dataset sync failed"
    exit 1
fi
### ==============================
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))
DURATION="$((ELAPSED / 3600))h $(((ELAPSED / 60) % 60))m $((ELAPSED % 60))s"

echo "=== Backup finished in $DURATION ==="
send_notification "ZFS Backup" "Success" "Backup completed successfully in $DURATION ‚úÖ"
"$WAIT_JOBS_ENABLE_SLEEP"#!/usr/bin/env bash
set -euo pipefail

source ~/scripts/notifications.sh
source ~/secret/saralab_bot.secret

LOCKFILE="/run/zfs-backup.lock"
START_TIME=$(date +%s)

PBS_HOST="pbs.l"
PBS_DATA="pbs/data_bkp"
PBS_VMS="pbs/vms_bkp"
DATASET_DIR="mmd_server/data"
CFG_DIR="/mmd_server/bkp/config"
VZDUMP_LOCK="/var/run/vzdump.lock"
LOG_FILE="/var/log/zfs-backup.log"
PBS_USER="root"
PBS_SSH="root@main.l"

PREPARE_FOR_BKP="$HOME/scripts/prepare-for-backup.sh"

WAIT_JOBS_ENABLE_SLEEP="$HOME/scripts/enable-sleep-no-jobs.sh"

PBS_WAIT_TIMEOUT=300   # seconds
PBS_WAIT_INTERVAL=5

# Redirect stdout/stderr to log file and console
mkdir -p "$(dirname "$LOG_FILE")"
exec > >(tee -a "$LOG_FILE") 2>&1

# Locking
exec 9>"$LOCKFILE"
flock -n 9 || { echo "Another backup is running, exiting."; exit 0; }


      
trap 'echo "‚ö†Ô∏è Backup interrupted!"; exit 1' INT  # Handle Ctrl+C
trap 'LINE=$LINENO; send_notification "ZFS Backup" "Failed" "Backup failed ‚ùå at line $LINE"; exit 1' ERR


echo "=== Backup started at $(date -Is) ==="

### ==============================
### Wait for vzdump
### ==============================
wait_for_vzdump() {
    [[ -e "$VZDUMP_LOCK" ]] || return 0
    echo "Waiting for vzdump..."
    exec 8<"$VZDUMP_LOCK"
    flock 8
    exec 8>&-
}

wait_for_vzdump




### ==============================
### 1Ô∏è‚É£ Backup Proxmox config
### ==============================
mkdir -p "$CFG_DIR"
CFG_FILE="$CFG_DIR/pve-config-$(date +%F).tar.gz"
echo "Creating Proxmox config backup..."
tar -czf "$CFG_FILE" \
  /etc/pve \
  /etc/network \
  /etc/ssh \
  /etc/apt \
  /etc/fstab \
  /etc/hosts
echo "‚úÖ Config backup done: $CFG_FILE"

wait_for_vzdump

SYNCOID_CMD=(
  syncoid
  --quiet
  --no-sync-snap
  --no-privilege-elevation
  --force-delete
  --recursive
)

### ==============================
### Wake PBS & prepare
### ==============================
"$PREPARE_FOR_BKP"

echo "Syncing datasets to PBS..."
trap - ERR

"${SYNCOID_CMD[@]}" "$DATASET_DIR" "$PBS_HOST:$PBS_DATA" 2>&1 | tee -a "$LOG_FILE"
status=${PIPESTATUS[0]}  # exit status of syncoid

trap 'LINE=$LINENO; send_notification "ZFS Backup" "Failed" "Backup failed ‚ùå at line $LINE"; exit 1' ERR

if [ $status -eq 0 ] || [ $status -eq 2 ]; then
    echo "‚úÖ Datasets synced (or nothing new to sync)"
else
    echo "‚ùå Dataset sync failed"
    exit 1
fi
### ==============================
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))
DURATION="$((ELAPSED / 3600))h $(((ELAPSED / 60) % 60))m $((ELAPSED % 60))s"

echo "=== Backup finished in $DURATION ==="
send_notification "ZFS Backup" "Success" "Backup completed successfully in $DURATION ‚úÖ"
"$WAIT_JOBS_ENABLE_SLEEP"